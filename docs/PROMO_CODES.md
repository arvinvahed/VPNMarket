# راهنمای قابلیت کدهای تخفیف (Promo Codes)

## مقدمه

این قابلیت امکان ایجاد و مدیریت کدهای تخفیف را برای مدیران سایت فراهم می‌کند. کاربران می‌توانند هنگام خرید از این کدها استفاده کرده و تخفیف دریافت کنند.

## ویژگی‌های اصلی

- **انواع تخفیف**: درصدی یا مبلغ ثابت
- **محدودیت استفاده**: تعداد کل و تعداد برای هر کاربر
- **تاریخ اعتبار**: تاریخ شروع و انقضا
- **اعمال به پلن خاص**: امکان تعریف کد برای پلن‌های خاص
- **مدیریت در پنل ادمین**: رابط کاربری ساده برای مدیریت کدها
- **ردیابی استفاده**: مشاهده تعداد استفاده از هر کد

## نحوه استفاده برای مدیران

### ایجاد کد تخفیف جدید

1. وارد پنل ادمین شوید (`/admin`)
2. از منوی سمت راست، بخش **بازاریابی > کدهای تخفیف** را انتخاب کنید
3. روی دکمه **ایجاد** کلیک کنید
4. فرم را با اطلاعات زیر پر کنید:

#### اطلاعات اصلی
- **کد تخفیف**: کد منحصر به فرد (به صورت خودکار به حروف بزرگ تبدیل می‌شود)
- **توضیحات**: توضیحات اختیاری برای شناسایی بهتر کد

#### تنظیمات تخفیف
- **نوع تخفیف**: 
  - درصدی: تخفیف بر اساس درصد (مثلاً 10%)
  - مبلغ ثابت: تخفیف با مبلغ مشخص (مثلاً 5000 تومان)
- **مقدار تخفیف**: عدد تخفیف (برای درصدی بین 0 تا 100)
- **واحد پول**: برای تخفیف ثابت (پیش‌فرض: تومان)

#### محدودیت‌های استفاده
- **حداکثر تعداد استفاده کل**: تعداد دفعاتی که کد می‌تواند استفاده شود (خالی = نامحدود)
- **حداکثر تعداد استفاده هر کاربر**: هر کاربر چند بار می‌تواند از کد استفاده کند (خالی = نامحدود)

#### تاریخ اعتبار
- **تاریخ شروع**: زمان شروع اعتبار کد (خالی = فوری)
- **تاریخ انقضا**: زمان پایان اعتبار کد (خالی = بدون انقضا)

#### قابلیت اعمال
- **قابل اعمال به**: 
  - همه پلن‌ها: کد برای همه پلن‌ها قابل استفاده است
  - پلن خاص: فقط برای یک پلن مشخص

#### وضعیت
- **فعال**: فعال/غیرفعال بودن کد

5. روی **ایجاد** کلیک کنید

### مدیریت کدهای موجود

در صفحه لیست کدهای تخفیف می‌توانید:

- **مشاهده تمام کدها**: جدولی با تمام اطلاعات کدها
- **جستجو**: جستجو بر اساس کد یا توضیحات
- **فیلتر کردن**: 
  - فعال/غیرفعال
  - منقضی شده یا به زودی منقضی
  - حذف شده (سافت دیلیت)
- **فعال/غیرفعال کردن سریع**: با کلیک روی دکمه در ستون اکشن
- **ویرایش**: ویرایش اطلاعات کد
- **حذف**: حذف نرم (امکان بازگردانی)
- **حذف کامل**: حذف دائمی از دیتابیس

### نمونه کدهای تخفیف

پس از اجرای Seeder، کدهای زیر در دیتابیس ایجاد می‌شوند:

- **WELCOME10**: تخفیف 10% خوش‌آمدگویی (حداکثر 100 استفاده، هر کاربر 1 بار)
- **SAVE20**: تخفیف 20% ویژه (حداکثر 50 استفاده، هر کاربر 2 بار، 30 روز اعتبار)
- **OFF5000**: تخفیف 5000 تومانی (حداکثر 20 استفاده، 15 روز اعتبار)

## نحوه استفاده برای کاربران

### اعمال کد تخفیف هنگام خرید

1. پس از انتخاب پلن و ایجاد سفارش، به صفحه پرداخت هدایت می‌شوید
2. در بخش **کد تخفیف دارید؟** کد خود را وارد کنید
3. روی دکمه **اعمال** کلیک کنید
4. در صورت معتبر بودن کد:
   - پیام موفقیت نمایش داده می‌شود
   - مبلغ اولیه با خط خورده نمایش داده می‌شود
   - مبلغ تخفیف نمایش داده می‌شود
   - مبلغ نهایی محاسبه و نمایش داده می‌شود
5. می‌توانید با روش دلخواه پرداخت کنید

### پیام‌های خطا

در صورت وجود مشکل، یکی از پیام‌های زیر نمایش داده می‌شود:

- **کد تخفیف معتبر نیست**: کد وجود ندارد
- **این کد تخفیف غیرفعال است**: کد غیرفعال شده
- **این کد تخفیف هنوز فعال نشده است**: تاریخ شروع نرسیده
- **این کد تخفیف منقضی شده است**: تاریخ انقضا گذشته
- **این کد تخفیف به حد مجاز استفاده رسیده است**: تعداد استفاده کامل شده
- **شما قبلاً از این کد تخفیف استفاده کرده‌اید**: محدودیت هر کاربر
- **این کد تخفیف برای این پلن قابل استفاده نیست**: کد مخصوص پلن دیگر است

## معماری فنی

### جداول دیتابیس

#### promo_codes
- `id`: شناسه منحصر به فرد
- `code`: کد تخفیف (unique, uppercase)
- `description`: توضیحات
- `discount_type`: نوع تخفیف (percent/fixed)
- `discount_value`: مقدار تخفیف
- `currency`: واحد پول (برای fixed)
- `max_uses`: حداکثر استفاده کل
- `max_uses_per_user`: حداکثر استفاده هر کاربر
- `uses_count`: تعداد استفاده شده
- `start_at`: تاریخ شروع
- `expires_at`: تاریخ انقضا
- `active`: وضعیت فعال/غیرفعال
- `applies_to`: نوع اعمال (all/plan/provider)
- `plan_id`: شناسه پلن (nullable)
- `provider_id`: شناسه ارائه‌دهنده (nullable)
- `created_by_admin_id`: شناسه ادمین ایجادکننده
- `created_at`, `updated_at`, `deleted_at`

#### orders (فیلدهای جدید)
- `promo_code_id`: شناسه کد تخفیف استفاده شده
- `discount_amount`: مبلغ تخفیف
- `original_amount`: مبلغ اولیه قبل از تخفیف

### کلاس‌ها و سرویس‌ها

#### PromoCode Model
- مدل اصلی با متدهای کمکی:
  - `isValid()`: بررسی اعتبار کد
  - `canBeUsedByUser()`: بررسی محدودیت کاربر
  - `appliesToPlan()`: بررسی پلن
  - `calculateDiscount()`: محاسبه تخفیف

#### CouponService
سرویس مدیریت کوپن‌ها با متدهای:
- `validateCode()`: اعتبارسنجی کد
- `calculateDiscount()`: محاسبه تخفیف
- `applyToOrder()`: اعمال به سفارش
- `removeFromOrder()`: حذف از سفارش
- `incrementUsage()`: افزایش شمارنده استفاده (atomic)

#### PromoCodeResource (Filament)
- رابط کاربری ادمین
- فرم‌ها با اعتبارسنجی
- جدول با فیلترها و اکشن‌ها
- فارسی‌سازی کامل

### روت‌های API

```php
// Authenticated routes
POST /order/{order}/apply-coupon    // اعمال کد تخفیف
POST /order/{order}/remove-coupon   // حذف کد تخفیف
```

### تست‌ها

تست‌های جامع با Pest:
- ایجاد و اعتبارسنجی کدها
- محاسبات تخفیف (درصدی و ثابت)
- اعمال و حذف از سفارش
- محدودیت‌های استفاده
- افزایش atomic شمارنده
- محدودیت هر کاربر
- پلن‌های خاص

## راه‌اندازی و نصب

### Migration

```bash
php artisan migrate
```

این دستور جداول `promo_codes` و فیلدهای جدید در جدول `orders` را ایجاد می‌کند.

### Seeder

برای ایجاد کدهای تخفیف نمونه:

```bash
php artisan db:seed --class=PromoCodeSeeder
```

### تست‌ها

برای اجرای تست‌ها:

```bash
php artisan test --filter=PromoCodeTest
```

## نکات امنیتی

- کدها به صورت خودکار uppercase می‌شوند
- شمارنده uses_count با استفاده از DB::increment به صورت atomic افزایش می‌یابد تا از race condition جلوگیری شود
- اعتبارسنجی کامل در سمت سرور
- فقط کاربران احراز هویت شده می‌توانند کد اعمال کنند
- هر کاربر فقط می‌تواند کد را به سفارش خودش اعمال کند

## توسعه‌های آینده

- امکان ایجاد کد توسط ارائه‌دهندگان (providers)
- گزارش‌های تحلیلی از استفاده کدها
- Export CSV از لیست کدها
- ایجاد کدهای تخفیف یکبار مصرف برای کاربران خاص
- نوتیفیکیشن برای کدهای نزدیک به انقضا

## پشتیبانی

در صورت بروز مشکل یا سوال:
1. ابتدا لاگ‌های Laravel را بررسی کنید (`storage/logs/laravel.log`)
2. مطمئن شوید migrations اجرا شده‌اند
3. تست‌ها را اجرا کنید تا از صحت عملکرد مطمئن شوید
